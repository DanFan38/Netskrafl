
{% extends "container.html" %}

{% block scripts %}

<link href="{{ url_for('static', filename='jquery-ui.css') }}" rel="stylesheet" type="text/css">

{% endblock %}

{% block content %}

<div class="tabbed-page">

   <div id="tabs">
   <ul>
      <li><a href="#tabs-1"><span class='glyphicon glyphicon-th'></span>&nbsp;&nbsp;Viðureignir</a></li>
      <li><a href="#tabs-2"><span class='glyphicon glyphicon-hand-right'></span>&nbsp;&nbsp;Áskoranir</a></li>
      <li><a href="#tabs-3"><span class='glyphicon glyphicon-user'></span>&nbsp;&nbsp;Andstæðingar</a></li>
      <li><a href="#tabs-4"><span class='glyphicon glyphicon-bookmark'></span>&nbsp;&nbsp;Ferill</a></li>
   </ul>

   <div id="tabs-1">

      <p>Viðureignir sem standa yfir - smelltu til að skoða stöðuna og leika ef
      <span class='glyphicon glyphicon-flag'></span> þú átt leik:</p>

      <div class="listitem listheader"><span
      class="list-myturn"><span title="Átt þú leik?" class='glyphicon glyphicon-flag grayed'></span></span><span
      class="list-ts">Síðasti leikur</span><span
      class="list-opp">Andstæðingur</span><span
      class="list-scorehdr">Staða</span></div>

      <!-- Game list will be populated by populateGameList() below -->
      <div id="gamelist"></div>

   </div>

   <div id="tabs-2">

      <p>Skorað á þig - smelltu til að taka áskoruninni og hefja leik:</p>

      <div class="listitem listheader"><span
      class="list-icon"><span title="Hafna" class='glyphicon glyphicon-thumbs-down grayed'></span></span><span
      class="list-ts">Hvenær</span><span
      class="list-nick">Áskorandi</span><span
      class="list-chall">Hvernig</span></div>

      <!-- Challenge lists will be populated by populateChallengeList() below -->
      <div id="chall-received"></div>

      <p>Þú skorar á aðra:</p>

      <div class="listitem listheader"><span
      class="list-icon"><span title="Afturkalla" class='glyphicon glyphicon-hand-right grayed'></span></span><span
      class="list-ts">Hvenær</span><span
      class="list-nick">Andstæðingur</span><span
      class="list-chall">Hvernig</span></div>

      <div id="chall-sent"></div>

   </div>

   <div id="tabs-4">
      <p>Nýlegar viðureignir þínar - smelltu til að skoða og rifja upp:</p>
      <div class="listitem listheader"><span
      class="list-win"><span title="Sigur" class='glyphicon glyphicon-bookmark grayed'></span></span><span class="list-ts">Viðureign hófst</span><span class="list-opp">Andstæðingur</span><span class="list-scorehdr">Úrslit</span></div>

      <!-- Recent game lists will be populated by populateRecentList() below -->
      <div id="recentlist"></div>

   </div>

   <div id="tabs-3">
      <p id="initials">
         <span id="robots" class="shown"><span style='padding:0' class='glyphicon glyphicon-cog'></span> Þjarkar</span>
         <span id="fav"><span style='padding:0' class='glyphicon glyphicon-star'></span> Uppáhalds</span>
         <span>a-c</span><span>d-é</span>
         <span>f-g</span><span>h-í</span>
         <span>j-k</span><span>l-n</span>
         <span>o-q</span><span>r-s</span>
         <span>t-ú</span><span>v-z</span>
         <span>þ-ö</span>
      </p>
      <div class="listitem listheader">
         <span
         class="list-ch"><span title="Skora á"
         class='glyphicon glyphicon-hand-right grayed'></span></span><span
         class="list-fav"><span title="Uppáhald"
         class='glyphicon glyphicon-star-empty'></span></span><span
         class="list-nick">Einkenni</span><span
         class="list-fullname">Nafn</span>
      </div>

      <!-- User list will be populated by populateUserList() below -->
      <div id="userlist"></div>

   </div>

   </div> <!-- id="tabs" -->

</div> <!-- class="tabbed-page" -->

<!-- Display user identifier in upper right corner -->

<div class="userid">
   <a href="{{ url_for('userprefs') }}">{{ user.nickname() }}</a>
</div>

{% endblock %}

{% block endscripts %}

<script>

var entityMap = {
   "&": "&amp;",
   "<": "&lt;",
   ">": "&gt;",
   '"': '&quot;',
   "'": '&#39;',
   "/": '&#x2F;'
};

function escapeHtml(string) {
   /* Utility function to properly encode a string into HTML */
   return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
   });
}

function nullFunc(json) {
   /* Null placeholder function to use for Ajax queries that don't need a success func */
}

function errFunc(xhr, status, errorThrown) {
   /* Error handling function for Ajax communications */
   alert("Villa í netsamskiptum");
   console.log("Error: " + errorThrown);
   console.log("Status: " + status);
   console.dir(xhr);
}

function serverQuery(requestUrl, jsonData, successFunc) {
   /* Wraps a simple, standard Ajax request to the server */
   $.ajax({
      // The URL for the request
      url: requestUrl,

      // The data to send
      data: jsonData,

      // Whether this is a POST or GET request
      type: "POST",

      // The type of data we expect back
      dataType : "json",

      cache: false,

      // Code to run if the request succeeds;
      // the response is passed to the function
      success: (!successFunc) ? nullFunc : successFunc,

      // Code to run if the request fails; the raw request and
      // status codes are passed to the function
      error: errFunc,

      // code to run regardless of success or failure
      complete: function(xhr, status) {
      }
   });
}

function markFavorite(elem, uid) {
   /* Toggle a favorite mark for the indicated user */
   var action;
   if ($(elem).hasClass("glyphicon-star-empty")) {
      $(elem).removeClass("glyphicon-star-empty");
      $(elem).addClass("glyphicon-star");
      action = "add";
   }
   else {
      $(elem).removeClass("glyphicon-star");
      $(elem).addClass("glyphicon-star-empty");
      action = "delete";
   }
   serverQuery("/favorite",
      {
         // Identify the relation in question
         destuser: uid,
         action: action
      }, null); // No success func needed - it's a one-way notification
}

function updateChallenges(json) {
   /* Coming back from an update of challeges:
      refresh the challenge list */
   refreshChallengeList();
}

function markChallenge(elem, uid) {
   /* Change the state of a challenge for the indicated user */
   var action;
   if ($(elem).hasClass("glyphicon-thumbs-down")) {
      /* A challenge from another user is being declined */
      action = "decline";
   }
   else
   if ($(elem).hasClass("grayed")) {
      $(elem).removeClass("grayed");
      /* A challenge is being issued to another user */
      action = "issue";
   }
   else {
      /* A challenge to another user is being retracted */
      $(elem).addClass("grayed");
      action = "retract";
   }
   if (action == "issue" && uid.indexOf("robot-") === 0) {
      /* Challenging a robot: Create a new game and display it right away */
      window.location.href = "{{ url_for('newgame') | safe }}" + "?opp=" + uid;
      return;
   }
   serverQuery("/challenge",
      {
         // Identify the relation in question
         destuser: uid,
         action: action
      }, updateChallenges);
}

function populateUserList(json) {
   if (!json || json.result === undefined)
      return;
   if (json.result !== 0)
      /* Probably out of sync or login required */
      /* !!! TBD: Add error reporting here */
      return;
   for (var i = 0; i < json.userlist.length; i++) {
      var item = json.userlist[i];
      // Robot userids start with 'robot-'
      var isRobot = item.userid.indexOf("robot-") === 0;
      var fav;
      if (isRobot)
         // Can't favorite a robot
         fav = "<span class='glyphicon glyphicon-star-empty'></span>";
      else
         fav = "<span title='Uppáhald' class='glyphicon glyphicon-star" +
         ((!item.fav) ? "-empty" : "") +
         "' onclick='markFavorite(this, \"" + item.userid + "\")'></span>";
      var ch = "<span title='Skora á' class='glyphicon glyphicon-hand-right" +
         (item.chall ? "'" : " grayed'") +
         " onclick='markChallenge(this, \"" + item.userid + "\")'></span>";
      var nick = escapeHtml(item.nick);
      if (isRobot)
         // Mark robots with a cog icon
         nick = "<span class='glyphicon glyphicon-cog'></span>&nbsp;" + nick;
      var str = "<div class='listitem " + ((i % 2 === 0) ? "oddlist" : "evenlist") + "'>" +
         "<span class='list-ch'>" + ch + "</span>" +
         "<span class='list-fav'>" + fav + "</span>" +
         "<span class='list-nick'>" + nick + "</span>" +
         "<span class='list-fullname'>" + escapeHtml(item.fullname) + "</span>" +
         "</div>";
      $("#userlist").append(str);
   }
}

var displayedUserRange = null;

function redisplayUserList() {
   /* Redisplay the user list that is being shown */
   if (displayedUserRange !== null)
      refreshUserList({ data: displayedUserRange });
}

function refreshUserList(ev) {
   /* Erase existing user list, if any */
   $("#userlist").html("");
   /* Indicate which subtab is being shown */
   if (ev.target) {
      $("#initials span").removeClass("shown");
      $(ev.target).addClass("shown");
   }
   /* Establish the alphabet range that we want to display */
   var range = ev.data;
   var from_range = null;
   var to_range = null;
   /* Note the last displayed range in case we need to redisplay */
   displayedUserRange = range;
   if (range == "fav" || range == "robots") {
      /* Special requests: list of favorites or robots */
      from_range = range;
   }
   else {
      from_range = range ? range.charAt(0) : null;
      to_range = from_range;
      if (range && range.length == 3)
         /* Range has x-y format */
         to_range = range.charAt(2);
   }
   serverQuery("/userlist",
      {
         // Identify the game in question
         from: from_range,
         to: to_range
      },
      populateUserList);
}

function populateGameList(json) {
   if (!json || json.result === undefined)
      return;
   if (json.result !== 0)
      /* Probably out of sync or login required */
      /* !!! TBD: Add error reporting here */
      return;
   for (var i = 0; i < json.gamelist.length; i++) {
      var item = json.gamelist[i];
      var opp = escapeHtml(item.opp);
      if (item.opp_is_robot)
         // Mark robots with a cog icon
         opp = "<span class='glyphicon glyphicon-cog'></span>&nbsp;" + opp;
      var turnText = item.my_turn ? "Þú átt leik" : (opp + " á leik");
      var myTurn = "<span title='" + turnText + "' class='glyphicon glyphicon-flag" +
         (item.my_turn ? "" : " grayed") + "'></span>";
      var str = "<div class='listitem " + ((i % 2 === 0) ? "oddlist" : "evenlist") + "'>" +
         "<a href='" + item.url + "'>" +
         "<span class='list-myturn'>" + myTurn + "</span>" +
         "<span class='list-ts'>" + item.ts + "</span>" +
         "<span class='list-opp'>" + opp + "</span>" +
         "<span class='list-s0'>" + item.sc0 + "</span>:" +
         "<span class='list-s1'>" + item.sc1 + "</span>" +
         "</a></div>";
      $("#gamelist").append(str);
   }
}

function refreshGameList() {
   /* Update list of active games for the current user */
   $("#gamelist").html("");
   serverQuery("/gamelist",
      {
         // No data to send with query - current user is implicit
      },
      populateGameList);
}

function populateRecentList(json) {
   if (!json || json.result === undefined)
      return;
   if (json.result !== 0)
      /* Probably out of sync or login required */
      /* !!! TBD: Add error reporting here */
      return;
   for (var i = 0; i < json.recentlist.length; i++) {
      var item = json.recentlist[i];
      var opp = escapeHtml(item.opp);
      if (item.opp_is_robot)
         // Mark robots with a cog icon
         opp = "<span class='glyphicon glyphicon-cog'></span>&nbsp;" + opp;
      var myWin = "<span class='glyphicon glyphicon-bookmark" +
         (item.sc0 >= item.sc1 ? "" : " grayed") + "'></span>";
      var str = "<div class='listitem " + ((i % 2 === 0) ? "oddlist" : "evenlist") + "'>" +
         "<a href='" + item.url + "'>" +
         "<span class='list-win'>" + myWin + "</span>" +
         "<span class='list-ts'>" + item.ts + "</span>" +
         "<span class='list-opp'>" + opp + "</span>" +
         "<span class='list-s0'>" + item.sc0 + "</span>:" +
         "<span class='list-s1'>" + item.sc1 + "</span>" +
         "</a></div>";
      $("#recentlist").append(str);
   }
}

function refreshRecentList() {
   /* Update list of recent games for the current user */
   $("#recentlist").html("");
   serverQuery("/recentlist",
      {
         // No data to send with query - current user is implicit
      },
      populateRecentList);
}

function acceptChallenge(userid) {
   /* Accept a previously issued challenge from the user in question */
   window.location.href = "{{ url_for('newgame') | safe }}" + "?opp=" + userid;
}

function markChallAndRefresh(elem, userid) {
   /* Mark a challenge and refresh the user list */
   markChallenge(elem, userid);
   redisplayUserList();
}

function populateChallengeList(json) {
   if (!json || json.result === undefined)
      return;
   if (json.result !== 0)
      /* Probably out of sync or login required */
      /* !!! TBD: Add error reporting here */
      return;
   var countReceived = 0, countSent = 0;
   for (var i = 0; i < json.challengelist.length; i++) {
      var item = json.challengelist[i];
      var opp = escapeHtml(item.opp);
      var prefs = escapeHtml(item.prefs);
      var odd = ((item.received ? countReceived : countSent) % 2 === 0);
      /* Show Decline icon (thumb down) if received challenge;
         show Delete icon (cross) if issued challenge */
      var icon;
      if (item.received)
         icon = "<span title='Hafna' " +
            "class='glyphicon glyphicon-thumbs-down'";
      else
         icon = "<span title='Afturkalla' " +
            "class='glyphicon glyphicon-hand-right'";
      icon += " onclick='markChallAndRefresh(this, \"" + item.userid + "\")'></span>";
      var str = "<div class='listitem " + (odd ? "oddlist" : "evenlist") + "'>" +
         "<span class='list-icon'>" + icon + "</span>" +
         (item.received ? ("<a href='#' onclick='acceptChallenge(\"" + item.userid + "\")'>") : "") +
         "<span class='list-ts'>" + item.ts + "</span>" +
         "<span class='list-nick'>" + opp + "</span>" +
         "<span class='list-chall'>" + prefs + "</span>" +
         (item.received ? "</a>" : "") + "</div>";
      if (item.received) {
         $("#chall-received").append(str);
         countReceived++;
      }
      else {
         $("#chall-sent").append(str);
         countSent++;
      }
   }
}

function refreshChallengeList() {
   /* Clear list of challenges received by this user */
   $("#chall-received").html("");
   /* Clear list of challenges sent by this user */
   $("#chall-sent").html("");
   serverQuery("/challengelist",
      {
         // No data to send with query - current user is implicit
      },
      populateChallengeList);
}

$("#tabs").tabs();

/* Initialize game list */
refreshGameList();

/* Initialize list of recent games */
refreshRecentList();

/* Initialize challenge list */
refreshChallengeList();

/* Initialize user list to show robots by default */
refreshUserList({ data: "robots" });

/* Initialize alphabet categories in user list header */
$("#initials").find("span").each(function() {
   var data = $(this).attr('id');
   if (data === undefined)
      // Not a special category, i.e. favorites or robots
      data = $(this).text();
   $(this).click(data, refreshUserList);
});

</script>

<!-- Google App Engine Channel API -->
<script type="text/javascript" src="/_ah/channel/jsapi"></script>

<script>

var channel = new goog.appengine.Channel("{{ channel_token }}");

function channelOnOpen() {
   alert("Channel open");
}

function channelOnMessage(msg) {
   /* Handle msg.data here */
   alert(msg.data);
}

function channelOnError(err) {
   /* Act on err.code and err.description here */
   alert("Channel error: " + err.code + "," + err.description);
}

function channelOnClose() {
   alert("Channel closed");
}

var socket = channel.open({
   onopen : channelOnOpen,
   onmessage : channelOnMessage,
   onerror : channelOnError,
   onclose : channelOnClose
});

</script>

{% endblock %}

