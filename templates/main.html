
{% extends "container.html" %}

{% block scripts %}

<link href="{{ url_for('static', filename='jquery-ui.css') }}" rel="stylesheet" type="text/css">

{% endblock %}

{% block content %}

<div class="help">

   <h2>Velkomin(n) í Netskrafl!</h2>

   <div id="tabs">
   <ul>
      <li><a href="#tabs-1">Viðureignir</a></li>
      <li><a href="#tabs-2">Áskoranir</a></li>
      <li><a href="#tabs-3">Andstæðingar</a></li>
      <li><a href="#tabs-4">Afrek</a></li>
   </ul>

   <div id="tabs-1">

      <p>Virkar viðureignir - smelltu til að skoða stöðuna og leika ef þú átt leik:</p>

      <div class="listitem listheader"><span class="list-ts">Viðureign hófst</span><span class="list-opp">Andstæðingur</span><span class="list-scorehdr">Staða</span></div>
{% for uuid, ts, opp, opp_is_robot, s0, s1 in current_games %}
      <div class="listitem {{ loop.cycle('oddlist', 'evenlist') }}"><a href="{{ url_for('board', game = uuid) }}"><span class="list-ts">{{ts}}</span><span class="list-opp">
{%- if opp_is_robot -%}
      <span class="glyphicon glyphicon-cog"></span>&nbsp;
{%- endif -%}
      {{ opp }}</span><span class="list-s0">{{s0}}</span>:<span class="list-s1">{{s1}}</span></a>
      </div>
{% endfor %}
   </div>

   <div id="tabs-2">

      <p>Skorað á þig:</p>

      <div class="listitem listheader"><span class="list-ts">Hvenær</span><span class="list-opp">Áskorandi</span><span class="list-chall">Hvernig</span></div>
{% for uuid, ts, opp, opp_is_robot, s0, s1 in current_games %}
      <div class="listitem {{ loop.cycle('oddlist', 'evenlist') }}"><a href="{{ url_for('board', game = uuid) }}"><span class="list-ts">{{ts}}</span><span class="list-opp">
{%- if opp_is_robot -%}
      <span class="glyphicon glyphicon-cog"></span>&nbsp;
{%- endif -%}
      {{ opp }}</span><span class="list-s0">{{s0}}</span>:<span class="list-s1">{{s1}}</span></a>
      </div>
{% endfor %}

      <p>Þú skorar á aðra:</p>

      <div class="listitem listheader"><span class="list-ts">Hvenær</span><span class="list-opp">Áskorandi</span><span class="list-chall">Hvernig</span></div>
{% for uuid, ts, opp, opp_is_robot, s0, s1 in current_games %}
      <div class="listitem {{ loop.cycle('oddlist', 'evenlist') }}"><a href="{{ url_for('board', game = uuid) }}"><span class="list-ts">{{ts}}</span><span class="list-opp">
{%- if opp_is_robot -%}
      <span class="glyphicon glyphicon-cog"></span>&nbsp;
{%- endif -%}
      {{ opp }}</span><span class="list-s0">{{s0}}</span>:<span class="list-s1">{{s1}}</span></a>
      </div>
{% endfor %}

   </div>

   <div id="tabs-4">
      <p>Nýlegar viðureignir þínar - smelltu til að skoða og rifja upp:</p>
      <div class="listitem listheader"><span class="list-ts">Viðureign hófst</span><span class="list-opp">Andstæðingur</span><span class="list-scorehdr">Úrslit</span></div>
{% for uuid, ts, opp, opp_is_robot, s0, s1 in recent_games %}
      <div class="listitem {{ loop.cycle('oddlist', 'evenlist') }}"><a href="{{ url_for('review', game = uuid) }}"><span class="list-ts">{{ts}}</span><span class="list-opp">
{%- if opp_is_robot -%}
      <span class="glyphicon glyphicon-cog"></span>&nbsp;
{%- endif -%}
      {{ opp }}</span><span class="list-s0">{{s0}}</span>:<span class="list-s1">{{s1}}</span></a>
      </div>
{% endfor %}
   </div>

   <div id="tabs-3">
      <p id="initials">
         <span id="fav">Uppáhalds</span>
         <span id="robots">Þjarkar</span>
         <span>a-á</span><span>b-c</span><span>d-ð</span><span>e-é</span>
         <span>f</span><span>g</span><span>h</span><span>i-í</span>
         <span>j</span><span>k</span><span>l</span><span>m</span>
         <span>n</span><span>o-ó</span><span>p-q</span><span>r</span>
         <span>s</span><span>t</span><span>u-ú</span><span>v-w</span>
         <span>x-z</span><span>þ</span><span>æ</span><span>ö</span>
      </p>
      <div class="listitem listheader">
         <span
         class="list-ch"><span title="Áskorun"
         class='glyphicon glyphicon-hand-right grayed'></span></span><span
         class="list-fav"><span title="Uppáhald"
         class='glyphicon glyphicon-star-empty'></span></span><span
         class="list-nick">Einkenni</span><span
         class="list-fullname">Nafn</span>
      </div>
      <!-- User list will be inserted here -->
      <div id="userlist"></div>
   </div>

   </div> <!-- id="tabs" -->

</div> <!-- class="help" -->

{% endblock %}

{% block endscripts %}

<script>

var entityMap = {
   "&": "&amp;",
   "<": "&lt;",
   ">": "&gt;",
   '"': '&quot;',
   "'": '&#39;',
   "/": '&#x2F;'
};

function escapeHtml(string) {
   /* Utility function to properly encode a string into HTML */
   return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
   });
}

function populateUserList(json) {
   if (!json || json.result === undefined)
      return;
   if (json.result !== 0)
      /* Probably out of sync or login required */
      /* !!! TBD: Add error reporting here */
      return;
   for (var i = 0; i < json.userlist.length; i++) {
      var item = json.userlist[i];
      // Robot userids start with 'robot-'
      var isRobot = item.userid.indexOf("robot-") === 0;
      var fav;
      if (isRobot)
         // Can't favorite a robot
         fav = "<span class='glyphicon glyphicon-star-empty'></span>";
      else
         fav = "<span title='Uppáhald' class='glyphicon glyphicon-star" +
         ((!item.fav) ? "-empty" : "") +
         "' onclick='markFavorite(this, \"" + item.userid + "\")'></span>";
      var ch = "<span title='Áskorun' class='glyphicon glyphicon-hand-right" +
         (item.chall ? "'" : " grayed'") +
         " onclick='markChallenge(this, \"" + item.userid + "\")'></span>";
      var nick = escapeHtml(item.nick);
      if (isRobot)
         // Mark robots with a cog icon
         nick = "<span class='glyphicon glyphicon-cog'></span>&nbsp;" + nick;
      var str = "<div class='listitem " + ((i % 2 === 0) ? "oddlist" : "evenlist") + "'>" +
         "<span class='list-ch'>" + ch + "</span>" +
         "<span class='list-fav'>" + fav + "</span>" +
         "<span class='list-nick'>" + nick + "</span>" +
         "<span class='list-fullname'>" + escapeHtml(item.fullname) + "</span>" +
         "</div>";
      $("#userlist").append(str);
   }
}

function markFavorite(elem, uid) {
   /* Toggle a favorite mark for the indicated user */
   var action;
   if ($(elem).hasClass("glyphicon-star-empty")) {
      $(elem).removeClass("glyphicon-star-empty");
      $(elem).addClass("glyphicon-star");
      action = "add";
   }
   else {
      $(elem).removeClass("glyphicon-star");
      $(elem).addClass("glyphicon-star-empty");
      action = "delete";
   }
   $.ajax({
      // the URL for the request
      url: "/favorite",

      // the data to send
      data: {
         // Identify the relation in question
         destuser: uid,
         action: action
      },

      // whether this is a POST or GET request
      type: "POST",

      // the type of data we expect back
      dataType : "json",

      cache: false,

      // code to run if the request succeeds;
      // the response is passed to the function
      success: function(json) { },

      // code to run if the request fails; the raw request and
      // status codes are passed to the function
      error: function(xhr, status, errorThrown) {
         alert("Villa í netsamskiptum");
         console.log("Error: " + errorThrown);
         console.log("Status: " + status);
         console.dir(xhr);
      },

      // code to run regardless of success or failure
      complete: function(xhr, status) {
      }
   });
}

function markChallenge(elem, uid) {
   /* Toggle a challenge for the indicated user */
   var action;
   if ($(elem).hasClass("grayed")) {
      $(elem).removeClass("grayed");
      action = "add";
   }
   else {
      $(elem).addClass("grayed");
      action = "delete";
   }
   $.ajax({
      // the URL for the request
      url: "/challenge",

      // the data to send
      data: {
         // Identify the relation in question
         destuser: uid,
         action: action
      },

      // whether this is a POST or GET request
      type: "POST",

      // the type of data we expect back
      dataType : "json",

      cache: false,

      // code to run if the request succeeds;
      // the response is passed to the function
      success: function(json) { },

      // code to run if the request fails; the raw request and
      // status codes are passed to the function
      error: function(xhr, status, errorThrown) {
         alert("Villa í netsamskiptum");
         console.log("Error: " + errorThrown);
         console.log("Status: " + status);
         console.dir(xhr);
      },

      // code to run regardless of success or failure
      complete: function(xhr, status) {
      }
   });
}

function refreshUserList(ev) {
   /* Erase existing user list, if any */
   $("#userlist").html("");
   /* Establish the alphabet range that we want to display */
   var range = ev.data;
   var from_range = null;
   var to_range = null;
   if (range == "fav" || range == "robots") {
      /* Special requests: list of favorites or robots */
      from_range = range;
   }
   else {
      from_range = range ? range.charAt(0) : null;
      to_range = from_range;
      if (range && range.length == 3)
         /* Range has x-y format */
         to_range = range.charAt(2);
   }
   $.ajax({
      // the URL for the request
      url: "/userlist",

      // the data to send
      data: {
         // Identify the game in question
         from: from_range,
         to: to_range
      },

      // whether this is a POST or GET request
      type: "POST",

      // the type of data we expect back
      dataType : "json",

      cache: false,

      // code to run if the request succeeds;
      // the response is passed to the function
      success: populateUserList,

      // code to run if the request fails; the raw request and
      // status codes are passed to the function
      error: function(xhr, status, errorThrown) {
         alert("Villa í netsamskiptum");
         console.log("Error: " + errorThrown);
         console.log("Status: " + status);
         console.dir(xhr);
      },

      // code to run regardless of success or failure
      complete: function(xhr, status) {
      }
   });
}

$("#tabs").tabs();

/* Initialize alphabet categories in user list header */
$("#initials").find("span").each(function() {
   var data = $(this).attr('id');
   if (data === undefined)
      // Not a special category, i.e. favorites or robots
      data = $(this).text();
   $(this).click(data, refreshUserList);
});

</script>

{% endblock %}

