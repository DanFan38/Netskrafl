
{% extends "container.html" %}

{% block styles %}

<link href="{{ url_for('static', filename='jquery-ui.css') }}" rel="stylesheet" type="text/css">

{% endblock %}

{% block scripts %}

<!-- Google App Engine Channel API -->
<script type="text/javascript" src="/_ah/channel/jsapi"></script>

<!-- Netskrafl client script -->
<script src="{{ url_for('static', filename='netskrafl.js') }}"></script>

<script>

   function placeTiles() {
      /* Initialize the board tiles */
{% for m in game.moves %}
{%- set coord, tiles, score = m.move.summary(game.state.board()) %}
      newestMove = placeMove({{ m.player }}, "{{ coord }}", "{{ tiles }}");
{% endfor %}

{% if game.my_turn(user.id()) %}
      /* Show the opponent's most recent move */
{% for m in game.moves[-1:] %}
      highlightNewestMove(colorOf({{ m.player }}));
{% endfor %}
{% endif %}

      /* Place the rack tiles */
{% if player_index != None %}
{% for tile, score in game.state.rack_details(player_index) %}
      placeTile("R{{ loop.index }}", "{{ tile }}", "{{ tile }}", {{ score }});
{%- endfor -%}
{%- endif -%}
   }

   function initMoveList() {
      /* Initialize the move list */
{% for m in game.moves %}
{%- set coord, tiles, score = m.move.summary(game.state.board()) %}
      appendMove({{ m.player }}, "{{ coord }}", "{{ tiles }}", {{ score }});
{% endfor %}
{% if game.is_over() %}
{% for m in game.get_final_adjustments() %}
      appendMove({{ m[0] }}, "{{ m[1][0] }}", "{{ m[1][1] }}", {{ m[1][2] }});
{% endfor %}
{% endif %}
   }

   function initBag(bag) {
      /* Initialize the bag */
{% if game.is_over() %}
      updateBag("{{ game.state.bag().contents() }}");
{% else %}
      updateBag("{{ game.display_bag(player_index) }}");
{% endif %}
{% if not game.state.is_exchange_allowed() %}
      exchangeAllowed = false;
{%- endif -%}      
   }

   function localPlayer() {
      /* Identify whether the current player is 0 or 1 */
      return {{ -1 if player_index == None else player_index }};
   }

   function gameId() {
      /* Return the unique identifier of this game */
      return "{{ game.id() }}";
   }

   function initialGameTime() {
      /* Return the time state of the game, i.e. its duration in minutes
         per player and the elapsed time so far for each player in seconds */
      return {
         duration: {{ time_info.duration }},
         elapsed: [{{ time_info.elapsed[0] }}, {{ time_info.elapsed[1] }}]
      };
   }

   function navToReview() {
      /* Show the game review page */
      window.location.href = "{{ url_for('review', game = game.id(), move = 0) | safe }}";
   }

   function lateInit() {
      /* Execute late initialization - called from initSkrafl() */
{% if channel_token %}      
      openChannel("{{ channel_token }}");
{% endif %}
      scoreLeft = {{ game.final_scores()[0] }};
      scoreRight = {{ game.final_scores()[1] }};
   }

</script>

{% endblock %}

{% block logo %}
{% include 'back.html' %}
{% endblock %}

{% block content %}

<!-- The board -->
{% include 'boardlayout.html' %}

<!-- Player names, scores and move history -->
<div class="rightcol">
   <div class="heading">
      <h3 class="playerleft"><span id="left-to-move" class="glyphicon-flag"></span>
{%- if player_index != None and player_index == 0 -%}
<a class="nodecorate" href="{{ url_for('userprefs') }}">
{%- elif game.is_autoplayer(0) -%}
<span class="glyphicon glyphicon-cog"></span>&nbsp;
{%- endif -%}
      {{ game.player_nickname(0) }}
{%- if player_index != None and player_index == 0 -%}
</a>
{%- endif -%}
      </h3>
      <h3 class="playerright">
{% if player_index != None and player_index == 1 %}
<a class="nodecorate" href="{{ url_for('userprefs') }}">
{%- elif game.is_autoplayer(1) -%}
<span class="glyphicon glyphicon-cog"></span>&nbsp;
{%- endif -%}
      {{ game.player_nickname(1) }}
{%- if player_index != None and player_index == 1 -%}
</a>
{%- endif -%}
      <span id="right-to-move" class="glyphicon-flag-after"></span></h3>
      <h3 class="scoreleft">{{ game.final_scores()[0] }}</h3>
      <h3 class="scoreright">{{ game.final_scores()[1] }}</h3>
      <h3 class="clockleft"></h3>
      <h3 class="clockright"></h3>
      <div class="clockface"><span class="glyphicon glyphicon-time"></span></div>
   </div>
   <div class="movelist">
   </div>
</div>

<!-- The rack -->
<div class="rack">
   <table class="board">
      <tr>
      <td id="R1"></td>
      <td id="R2"></td>
      <td id="R3"></td>
      <td id="R4"></td>
      <td id="R5"></td>
      <td id="R6"></td>
      <td id="R7"></td>
      </tr>
   </table>
</div>

<!-- The bag -->
<div class="bag" title="Flísar sem eftir eru í pokanum">
<table id="bag">
</table>
</div>

<!-- Word check -->
<div class="word-check"></div>

<!-- The score of the word currently laid down -->
<div class="score"></div>

<!-- A dialog to ask for the meaning of a blank tile -->
<div id="blank-dialog" class="modal-dialog">
<div id="blank-form" class="ui-widget ui-widget-content ui-corner-all">
   <p>Hvaða staf táknar auða flísin?</p>
   <div class="rack blank-rack">
      <table class="board" id="blank-meaning">
         <!-- Tile rows and cells will be inserted here -->
      </table>
   </div>
   <!-- Close button -->
   <div class="modal-close" id="blank-close" title="Hætta við" onmouseover="buttonOver(this)"
      onmouseout="buttonOut(this)"><span class="glyphicon glyphicon-remove"></span></div>
</div>
</div>

<!-- A button to recall all tiles back into the rack -->
<div class="recallbtn" title="Færa stafi aftur í rekka"
   onmouseover="this.classList.add('hover')"
   onmouseout="this.classList.remove('hover')"
   onclick="resetRack()"><span class="glyphicon glyphicon-circle-arrow-down"></span></div>

<!-- Move submit button -->
<div class="submitmove disabled" title="Leika" onmouseover="buttonOver(this)"
   onmouseout="buttonOut(this)" onclick="submitMove(this)">Leika <span class="glyphicon glyphicon-play"></span></div>

<!-- Wait placeholder -->
<div class="waitmove"><img src="{{ url_for('static', filename='ajax-loader.gif') }}" border=0/></div>

<!-- New game button -->
<div class="submitnewgame" title="Nýr leikur" onmouseover="buttonOver(this)"
   onmouseout="buttonOut(this)" onclick="window.location.href='{{ url_for('newgame') }}'">Nýr <span class="glyphicon glyphicon-play"></span></div>

<!-- Pass button -->
<div class="submitpass" title="Pass" onmouseover="buttonOver(this)"
   onmouseout="buttonOut(this)" onclick="submitPass(this)"><span class="glyphicon glyphicon-forward"></span></div>

<!-- Exchange button -->
<div class="submitexchange" title="Skipta stöfum" onmouseover="buttonOver(this)"
   onmouseout="buttonOut(this)" onclick="submitExchange(this)"><span class="glyphicon glyphicon-refresh"></span></div>

<!-- Resign button -->
<div class="submitresign" title="Gefa leik" onmouseover="buttonOver(this)"
   onmouseout="buttonOut(this)" onclick="submitResign(this)"><span class="glyphicon glyphicon-fire"></span></div>

<!-- Notification that it's the opponent's turn -->
{% if not game.is_over() %}
<div class="opp-turn"><span class="move-indicator"></span> <strong>{{ game.player_nickname(1 - player_index) }}</strong> á leik</div>
{% endif %}

<!-- Congratulations on a win -->
<div id="congrats"><span class="glyphicon glyphicon-bookmark"></span> <strong>Til hamingju með sigurinn!</strong></div>

<!-- Error message, normally hidden -->
<div class="error"><span class="glyphicon glyphicon-exclamation-sign"></span>
   <!-- Must match error list in skraflmechanics.py (Error class) -->
   <p id="err_1">Enginn stafur lagður niður</p> <!-- NULL_MOVE = 1 -->
   <p id="err_2">Fyrsta orð verður að liggja um miðjureitinn</p> <!-- FIRST_MOVE_NOT_IN_CENTER = 2 -->
   <p id="err_3">Orð verður að vera samfellt á borðinu</p> <!-- DISJOINT = 3 -->
   <p id="err_4">Orð verður að tengjast orði sem fyrir er</p> <!-- NOT_ADJACENT = 4 -->
   <p id="err_5">Reitur þegar upptekinn</p> <!-- SQUARE_ALREADY_OCCUPIED = 5 -->
   <p id="err_6">Ekki má vera eyða í orði</p> <!-- HAS_GAP = 6 -->
   <p id="err_7">'<span class="errword"></span>' finnst ekki í orðasafni</p> <!-- WORD_NOT_IN_DICTIONARY = 7 -->
   <p id="err_8">'<span class="errword"></span>' finnst ekki í orðasafni</p> <!-- CROSS_WORD_NOT_IN_DICTIONARY = 8 -->
   <p id="err_9">Of margir stafir lagðir niður</p> <!-- TOO_MANY_TILES_PLAYED = 9 -->
   <p id="err_10">Stafur er ekki í rekkanum</p> <!-- TILE_NOT_IN_RACK = 10 -->
   <p id="err_11">Of fáir stafir eftir, skipting ekki leyfð</p> <!-- EXCHANGE_NOT_ALLOWED = 11 -->
   <p id="err_12">Of mörgum stöfum skipt</p> <!-- TOO_MANY_TILES_EXCHANGED = 12 -->
   <p id="err_13">Leik vantar á borðið - notið F5/Refresh</p> <!-- OUT_OF_SYNC = 13 -->
   <p id="err_14">Notandi ekki innskráður - notið F5/Refresh</p> <!-- LOGIN_REQUIRED = 14 -->
   <p id="err_server">Netþjónn gat ekki tekið við leiknum - reyndu aftur</p> <!-- Server error, probably 5XX -->
</div>

<!-- Confirm resignation of game -->
<div class="resign"><span class="glyphicon glyphicon-exclamation-sign"></span>
   &nbsp;Viltu gefa leikinn?&nbsp;
   <span class="yesnobutton" onclick="confirmResign(true)">Já</span>
   <span class="yesnobutton" onclick="confirmResign(false)">Nei</span>
</div>

<!-- Exchange tiles -->
<div class="exchange"><span class="glyphicon glyphicon-refresh"></span>
   &nbsp;Smelltu á flísarnar sem þú vilt skipta&nbsp;
   <span class="yesnobutton xchgbtn" title="Skipta" onclick="confirmExchange(true)"><span class="glyphicon glyphicon-ok"></span></span>
   <span class="yesnobutton xchgbtn" title="Hætta við" onclick="confirmExchange(false)"><span class="glyphicon glyphicon-remove"></span></span>
</div>

{% if user.beginner() %}
<!-- Help on the board colors -->
<div class="board-help" title="Hvernig reitirnir margfalda stigin">
<div class="board-help-close" title="Loka þessari hjálp"><span class="glyphicon glyphicon-remove"></span></div>
<div class="board-colors">
<div class="board-color" id="triple-word">3 x<br>orð</div>
<div class="board-color" id="double-word">2 x<br>orð</div>
<div class="board-color" id="triple-letter">3 x<br> stafur</div>
<div class="board-color" id="double-letter">2 x<br> stafur</div>
<div class="board-color" id="single-letter">1 x<br> stafur</div>
</div>
</div>
{% endif %}

{%- endblock -%}

{%- block endscripts -%}

{%- if user.audio() -%}
<!-- Audio resources -->
<audio id="your-turn" preload="auto">
   <source src="{{ url_for('static', filename='your-turn.mp3') }}" type="audio/mpeg">
</audio>
{% endif %}

<script>

$(document).ready(initSkrafl);

</script>

{%- endblock -%}
