function escapeHtml(a){return String(a).replace(/[&<>"'\/]/g,function(a){return entityMap[a]})}function nullFunc(){}function errFunc(a,b,c){console.log("Error: "+c),console.log("Status: "+b),console.dir(a)}function serverQuery(a,b,c){$.ajax({url:a,data:b,type:"POST",dataType:"json",cache:!1,success:c?c:nullFunc,error:errFunc,complete:function(){}})}function buttonOver(a){$(a).hasClass("disabled")||$(a).toggleClass("over",!0)}function buttonOut(a){$(a).toggleClass("over",!1)}function markFavorite(a,b){var c;$(a).hasClass("glyphicon-star-empty")?($(a).removeClass("glyphicon-star-empty"),$(a).addClass("glyphicon-star"),c="add"):($(a).removeClass("glyphicon-star"),$(a).addClass("glyphicon-star-empty"),c="delete"),serverQuery("/favorite",{destuser:b,action:c},null)}function updateChallenges(){refreshChallengeList()}function markChallenge(a){var b,c=a.delegateTarget;if($(c).hasClass("glyphicon-thumbs-down")?b="decline":$(c).hasClass("grayed")?b="issue":($(c).addClass("grayed"),b="retract"),"issue"==b){if(0===a.data.userid.indexOf("robot-"))return void(window.location.href=newgameUrl(a.data.userid,!1));showChallenge(c.id,a.data.userid,a.data.nick,a.data.fullname)}else serverQuery("/challenge",{destuser:a.data.userid,action:b},updateChallenges)}function showUserInfo(a){$("#usr-info-nick").text(a.data.nick),$("#usr-info-fullname").text(a.data.fullname),initToggle("#stats-toggler",!1),$("#usr-stats-human").css("display","inline-block"),$("#usr-stats-all").css("display","none"),$("#usr-info-dialog").css("visibility","visible"),serverQuery("/recentlist",{user:a.data.userid,count:40},populateUserInfo),serverQuery("/userstats",{user:a.data.userid},populateUserStats)}function hideUserInfo(){$("#usr-info-dialog").css("visibility","hidden"),$("#usr-recent").html("")}function showStat(a,b,c,d,e){var f=c.toString();void 0!==e&&(f+=e),void 0!==d&&(f="<span class='glyphicon glyphicon-"+d+"'></span>&nbsp;"+f),$("#"+a+"-stats-"+b).html(f)}function _populateStats(a,b){showStat(a,"elo",b.elo,"crown"),showStat(a,"human-elo",b.human_elo,"crown"),showStat(a,"games",b.games,"th"),showStat(a,"human-games",b.human_games,"th");var c=0,d=0;b.games>0&&(c=Math.round(100*b.wins/b.games)),b.human_games>0&&(d=Math.round(100*b.human_wins/b.human_games));var e=0,f=0;b.games>0&&(e=Math.round(b.score/b.games)),b.human_games>0&&(f=Math.round(b.human_score/b.human_games)),showStat(a,"win-ratio",c,"bookmark","%"),showStat(a,"human-win-ratio",d,"bookmark","%"),showStat(a,"avg-score",e,"dashboard"),showStat(a,"human-avg-score",f,"dashboard")}function populateUserStats(a){_populateStats("usr",a)}function populateOwnStats(a){_populateStats("own",a)}function toggleStats(a){var b=toggle(a);$("#usr-stats-human").css("display",b?"none":"inline-block"),$("#usr-stats-all").css("display",b?"inline-block":"none")}function toggleOwnStats(a){var b=toggle(a);$("#own-stats-human").css("display",b?"none":"inline-block"),$("#own-stats-all").css("display",b?"inline-block":"none")}function populateUserList(a){if($("#user-load").css("display","none"),ulRq=!1,a&&void 0!==a.result&&0===a.result)for(var b=0;b<a.userlist.length;b++){var c,d=a.userlist[b],e=0===d.userid.indexOf("robot-");c=e?"<span class='glyphicon glyphicon-star-empty'></span>":"<span title='Uppáhald' class='glyphicon glyphicon-star"+(d.fav?"":"-empty")+"' onclick='markFavorite(this, \""+d.userid+"\")'></span>";var f="chall"+b.toString(),g="<span title='Skora á' class='glyphicon glyphicon-hand-right"+(d.chall?"'":" grayed'")+" id='"+f+"'></span>",h=escapeHtml(d.nick),i="",j="",k="",l="";e?(h="<span class='glyphicon glyphicon-cog'></span>&nbsp;"+h,i="<a href='"+newgameUrl(d.userid,!1)+"'>",j="</a>"):k="<span id='usr"+b.toString()+"' class='usr-info'></span>",k.length&&(k="<span class='list-info' title='Skoða feril'>"+k+"</span>"),d.ready&&!e&&(l="<span class='ready-btn' title='Álínis og tekur við áskorunum'></span> "),d.ready_timed&&(l+="<span class='timed-btn' title='Til í viðureign með klukku'></span> ");var m="<div class='listitem "+(b%2===0?"oddlist":"evenlist")+"'><span class='list-ch'>"+g+"</span><span class='list-fav'>"+c+"</span>"+i+"<span class='list-nick'>"+h+"</span><span class='list-fullname'>"+l+escapeHtml(d.fullname)+"</span>"+j+k+"</div>";$("#userlist").append(m),k.length&&$("#usr"+b.toString()).click({userid:d.userid,nick:d.nick,fullname:d.fullname},showUserInfo),$("#"+f).click({userid:d.userid,nick:d.nick,fullname:d.fullname},markChallenge)}}function rankStr(a,b){return 0===a||void 0!==b&&0===b?"--":a.toString()}function populateEloList(a){if($("#user-load").css("display","none"),ulRq=!1,a&&void 0!==a.result&&0===a.result)for(var b=0;b<a.rating.length;b++){var c=a.rating[b],d=0===c.userid.indexOf("robot-"),e="chall"+b.toString(),f="",g=escapeHtml(c.nick),h="";c.userid!=userId()&&(f="<span title='Skora á' class='glyphicon glyphicon-hand-right"+(c.chall?"'":" grayed'")+" id='"+e+"'></span>"),d?g="<span class='glyphicon glyphicon-cog'></span>&nbsp;"+g:h="<span id='usr"+b.toString()+"' class='usr-info'></span>",h.length&&(h="<span class='list-info' title='Skoða feril'>"+h+"</span>");var i="<div class='listitem "+(b%2===0?"oddlist":"evenlist")+"'><span class='list-ch'>"+f+"</span><span class='list-rank bold'>"+rankStr(c.rank)+"</span><span class='list-rank'>"+rankStr(c.rank_yesterday)+"</span><span class='list-rank'>"+rankStr(c.rank_week_ago)+"</span><span class='list-nick'>"+g+"</span><span class='list-elo bold'>"+c.elo.toString()+"</span><span class='list-elo'>"+rankStr(c.elo_yesterday,c.games_yesterday)+"</span><span class='list-elo'>"+rankStr(c.elo_week_ago,c.games_week_ago)+"</span><span class='list-elo'>"+rankStr(c.elo_month_ago,c.games_month_ago)+"</span><span class='list-games bold'>"+c.games.toString()+"</span><span class='list-ratio'>"+c.ratio.toString()+"%</span><span class='list-avgpts'>"+c.avgpts.toString()+"</span>"+h+"</div>";$("#userlist").append(i),h.length&&$("#usr"+b.toString()).click({userid:c.userid,nick:c.nick,fullname:c.fullname},showUserInfo),f.length&&$("#"+e).click({userid:c.userid,nick:c.nick,fullname:c.fullname},markChallenge)}}function toggleElo(a){if(!ulRq){var b=toggle(a);$("#userlist").html(""),$("#user-load").css("display","block"),ulRq=!0,serverQuery("/rating",{kind:b?"all":"human"},populateEloList)}}function redisplayUserList(){null!==displayedUserRange&&refreshUserList({data:displayedUserRange})}function periodicUserList(){displayedUserRange&&"live"==displayedUserRange&&refreshUserList({data:"live"})}function refreshUserList(a){if(!ulRq){ulRq=!0,$("#userlist").html(""),a.delegateTarget&&($("div.user-cat span").removeClass("shown"),$(a.delegateTarget).addClass("shown")),$("#user-load").css("display","block");var b=a.data+"",c=null,d=null;displayedUserRange=b+"","elo"==b?($("#usr-hdr").css("display","none"),$("#elo-hdr").css("display","block")):($("#elo-hdr").css("display","none"),$("#usr-hdr").css("display","block")),"fav"==b||"robots"==b||"live"==b||"elo"==b?c=b:(c=b?b.charAt(0):null,d=c,b&&3==b.length&&(d=b.charAt(2))),$("#usr-list-info").css("visibility","robots"==b?"hidden":"visible"),"elo"==b?serverQuery("/rating",{kind:"human"},populateEloList):serverQuery("/userlist",{from:c,to:d},populateUserList)}}function populateGameList(a){if(a&&void 0!==a.result&&0===a.result){for(var b=a.gamelist.length,c=0,d=0;b>d;d++){var e=a.gamelist[d],f=escapeHtml(e.opp);e.opp_is_robot&&(f="<span class='glyphicon glyphicon-cog'></span>&nbsp;"+f);var g;g=e.my_turn?"Þú átt leik":e.zombie?"Viðureign lokið":f+" á leik";var h=" grayed";e.my_turn?h="":e.zombie&&(h=" zombie");var i="<span title='"+g+"' class='glyphicon glyphicon-flag"+h+"'></span>",j=e.overdue?e.my_turn?"Er að renna út á tíma":"Getur þvingað fram uppgjöf":"",k="<span title='"+j+"' class='glyphicon glyphicon-hourglass"+(e.overdue?"":" grayed")+"'></span>",l=e.sc0<e.sc1?" losing":"",m="<div class='tilecount'><div class='tc"+l+"' style='width:"+Math.round(100*e.tile_count/104).toString()+"%'></div></div>",n="<div class='listitem "+(d%2===0?"oddlist":"evenlist")+"'><a href='"+e.url+"'><span class='list-myturn'>"+i+"</span><span class='list-overdue'>"+k+"</span><span class='list-ts'>"+e.ts+"</span><span class='list-opp'>"+f+"</span><span class='list-s0'>"+e.sc0+"</span><span class='list-colon'>:</span><span class='list-s1'>"+e.sc1+"</span><span class='list-tc'>"+m+"</span></a></div>";$("#gamelist").append(n),(e.my_turn||e.zombie)&&c++}0===c?($("#numgames").css("display","none"),document.title="Netskrafl"):($("#numgames").css("display","inline-block").text(c.toString()),document.title="("+c.toString()+") Netskrafl"),0===b?$("div.hint").css("display","block"):$("div.hint").css("display","none")}}function refreshGameList(){$("#gamelist").html(""),serverQuery("/gamelist",{},populateGameList)}function populateRecentList(a){_populateRecentList(a,"#recentlist")}function populateUserInfo(a){_populateRecentList(a,"#usr-recent")}function _populateRecentList(a,b){if(a&&void 0!==a.result&&0===a.result)for(var c=0;c<a.recentlist.length;c++){var d=a.recentlist[c],e=escapeHtml(d.opp);d.opp_is_robot&&(e="<span class='glyphicon glyphicon-cog'></span>&nbsp;"+e);var f="<span class='glyphicon glyphicon-bookmark"+(d.sc0>=d.sc1?"":" grayed")+"'></span>",g="";0===d.duration?(d.days||d.hours||d.minutes)&&(d.days>1?g=d.days.toString()+" dagar":1==d.days&&(g="1 dagur"),d.hours>0&&(g.length&&(g+=" og "),g+=d.hours.toString()+" klst"),0===d.days&&(g.length&&(g+=" og "),g+=1==d.minutes?"1 mínúta":d.minutes.toString()+" mínútur")):g="<span class='timed-btn' title='Viðureign með klukku'></span> 2 x "+d.duration.toString()+" mínútur";var h,i,j=d.elo_adj?d.elo_adj.toString():"",k=d.human_elo_adj?d.human_elo_adj.toString():"";null!==d.elo_adj&&(d.elo_adj>0?(j="+"+j,h="elo-win"):d.elo_adj<0?h="elo-loss":(h="elo-neutral",j="<span class='glyphicon glyphicon-stroller' title='Byrjandi'></span>")),null!==d.human_elo_adj&&(d.human_elo_adj>0?(k="+"+k,i="elo-win"):d.human_elo_adj<0?i="elo-loss":(i="elo-neutral",k="<span class='glyphicon glyphicon-stroller' title='Byrjandi'></span>")),j="<span class='elo-btn right "+h+(j.length?"":" invisible")+"'>"+j+"</span>",k="<span class='elo-btn left "+i+(k.length?"":" invisible")+"'>"+k+"</span>";var l="<div class='listitem "+(c%2===0?"oddlist":"evenlist")+"'><a href='"+d.url+"'><span class='list-win'>"+f+"</span><span class='list-ts'>"+d.ts_last_move+"</span><span class='list-nick'>"+e+"</span><span class='list-s0'>"+d.sc0+"</span><span class='list-colon'>:</span><span class='list-s1'>"+d.sc1+"</span><span class='list-elo-adj'>"+k+"</span><span class='list-elo-adj'>"+j+"</span><span class='list-duration'>"+g+"</span></a></div>";$(b).append(l)}}function refreshRecentList(){$("#recentlist").html(""),serverQuery("/recentlist",{count:40},populateRecentList),serverQuery("/userstats",{},populateOwnStats)}function acceptChallenge(a){a.preventDefault();var b=a.data,c=b.prefs;window.location.href=void 0!==c&&void 0!==c.duration&&c.duration>0?waitUrl(b.userid):newgameUrl(b.userid,!1)}function waitAccept(a){a&&a.waiting?window.location.href=newgameUrl(a.userid,!0):($("#accept-status").html("Andstæðingurinn <strong><span id='accept-opp'></span></strong> er ekki reiðubúinn"),$("#accept-opp").text($("#accept-nick").text()),refreshChallengeList())}function cancelAccept(){$("#accept-dialog").css("visibility","hidden")}function showAccept(a,b){$("#accept-status").text("Athuga hvort andstæðingur er reiðubúinn..."),$("#accept-nick").text(b),$("#accept-dialog").css("visibility","visible"),serverQuery("/waitcheck",{user:a},waitAccept)}function readyAccept(a){a.preventDefault();var b=a.data,c=b.prefs;void 0!==c&&void 0!==c.duration&&c.duration>0&&showAccept(b.userid,b.nick,c)}function markChallAndRefresh(a){markChallenge(a),redisplayUserList()}function challengeDescription(a){return a&&void 0!==a.duration&&0!==a.duration?"Með klukku, 2 x "+a.duration.toString()+" mínútur":"Venjuleg ótímabundin viðureign"}function readyFlasher(){$(".opp-ready").toggleClass("blink")}function populateChallengeList(a){if(ival&&(window.clearInterval(ival),ival=null),a&&void 0!==a.result&&0===a.result){$("#chall-received").html(""),$("#chall-sent").html("");for(var b=0,c=0,d=0,e=0;e<a.challengelist.length;e++){var f,g=a.challengelist[e],h=escapeHtml(g.opp),i=escapeHtml(challengeDescription(g.prefs)),j=(g.received?b:c)%2===0,k=!1;g.received?f="<span title='Hafna' class='glyphicon glyphicon-thumbs-down'":(f="<span title='Afturkalla' class='glyphicon glyphicon-hand-right'",g.opp_ready&&(k=!0));var l="accept"+e.toString(),m="ready"+e.toString(),n="chl"+e.toString();f+=" id='"+n+"'></span>";var o="<span id='chusr"+e.toString()+"' class='usr-info'></span>";o="<span class='list-info' title='Skoða feril'>"+o+"</span>";var p="<div class='listitem "+(j?"oddlist":"evenlist")+"'><span class='list-icon'>"+f+"</span>"+(g.received?"<a href='#' id='"+l+"'>":"")+(k?"<a href='#' id='"+m+"' class='opp-ready'>":"")+"<span class='list-ts'>"+g.ts+"</span><span class='list-nick'>"+h+"</span><span class='list-chall'>"+i+"</span>"+(g.received?"</a>":"")+(k?"</a>":"")+o+"</div>";g.received?($("#chall-received").append(p),$("#"+l).click({userid:g.userid,prefs:g.prefs},acceptChallenge),b++):($("#chall-sent").append(p),k&&($("#"+m).click({userid:g.userid,nick:g.opp,prefs:g.prefs},readyAccept),d++),c++),$("#"+n).click({userid:g.userid,nick:g.opp,fullname:""},markChallAndRefresh),$("#chusr"+e.toString()).click({userid:g.userid,nick:g.opp,fullname:""},showUserInfo)}b+d===0?$("#numchallenges").css("display","none"):$("#numchallenges").css("display","inline-block").text((b+d).toString()),d&&(ival=window.setInterval(readyFlasher,500))}}function refreshChallengeList(){null!==ivalChallengeList&&(window.clearInterval(ivalChallengeList),ivalChallengeList=null),serverQuery("/challengelist",{},populateChallengeList)}function prepareChallenge(){$("#chall-cancel").click(cancelChallenge),$("#chall-ok").click(okChallenge),$("div.chall-time").click(function(){$("div.chall-time").removeClass("selected"),$(this).addClass("selected")})}function markOnline(a){a&&void 0!==a.online&&a.online&&($("#chall-online").addClass("online"),$("#chall-online").attr("title","Er álínis"))}function showChallenge(a,b,c,d){$("#chall-nick").text(c),$("#chall-fullname").text(d),$("#chall-online").removeClass("online"),$("#chall-online").attr("title","Er ekki álínis"),$("#chall-dialog").data("param",{elemid:a,userid:b}).css("visibility","visible"),serverQuery("/onlinecheck",{user:b},markOnline)}function cancelChallenge(){$("#chall-dialog").data("param",null).css("visibility","hidden")}function okChallenge(a){var b=$("#chall-dialog").data("param"),c=$("div.chall-time.selected").attr("id").slice(6);c="none"==c?0:parseInt(c),serverQuery("/challenge",{destuser:b.userid,action:"issue",duration:c},updateChallenges),$("#"+b.elemid).removeClass("grayed"),cancelChallenge(a)}function toggle(a){var b="#"+a.delegateTarget.id,c=$(b+" #opt2").hasClass("selected");return $(b+" #opt1").toggleClass("selected",c),$(b+" #opt2").toggleClass("selected",!c),!c}function toggleReady(a){var b=toggle(a);serverQuery("/setuserpref",{ready:b})}function toggleTimed(a){var b=toggle(a);serverQuery("/setuserpref",{ready_timed:b})}function initToggle(a,b){$(a+" #opt2").toggleClass("selected",b),$(a+" #opt1").toggleClass("selected",!b)}function openChannel(a){channelToken=a,channel=new goog.appengine.Channel(a),socket=channel.open({onopen:channelOnOpen,onmessage:channelOnMessage,onerror:channelOnError,onclose:channelOnClose})}function channelOnOpen(){}function channelOnMessage(a){var b=jQuery.parseJSON(a.data);if((b.stale||"challenge"==b.kind)&&(refreshChallengeList(),redisplayUserList()),(b.stale||"game"==b.kind)&&refreshGameList(),b.kind&&"game"==b.kind){var c=document.getElementById("your-turn");c&&c.play()}}function channelOnError(){}function newChannel(a){a&&0===a.result&&openChannel(a.token)}function channelOnClose(){serverQuery("newchannel",{user:userId(),oldch:channelToken},newChannel),channelToken=null,channel=null,socket=null}function initMain(){$("#tabs").tabs({heightStyle:"auto",activate:function(a,b){var c=b.newPanel.attr("id");"tabs-4"==c?$("#recentlist").html()||refreshRecentList():"tabs-3"==c&&($("#userlist").html()||refreshUserList(null!==displayedUserRange?{data:displayedUserRange}:{data:"robots"}))}}),$("#opponents").click(function(){$("#tabs").tabs("option","active",2)}),refreshGameList(),ivalChallengeList=window.setInterval(refreshChallengeList,2e3),$("div.user-cat > span").each(function(){var a=$(this).attr("id");void 0===a&&(a=$(this).text()),$(this).click(a,refreshUserList)}),window.setInterval(periodicUserList,3e5),$("#usr-info-close").click(hideUserInfo),prepareChallenge(),$("#accept-cancel").click(cancelAccept),lateInit()}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},ulRq=!1,displayedUserRange=null,ival=null,ivalChallengeList=null,channel=null,socket=null,channelToken=null;